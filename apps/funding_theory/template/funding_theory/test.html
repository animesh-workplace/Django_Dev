{% extends 'funding_theory/base.html' %}

{% block content %}
<script type="text/javascript">
	tinymce.init({
		selector	: '.tinymce_textarea',
		branding	: false,
		theme		: 'silver',
		menubar		: false,
		statusbar	: false, 
		height		: '400',
	});
</script>

<section class="section">
  <div class="container">

  		<form method="post" id="tinymce_form"> {% csrf_token %}
  			<div class="columns">
  				<div class="column">
  				  	<p class="level-item has-text-centered"> Add Cactus Data Here </p> 
  					<textarea class="tinymce_textarea" id="text_1"></textarea> 
  				</div>
  				<div class="column"> 
  					<p class="level-item has-text-centered"> Add Cactus Meta Here </p>
  					<textarea class="tinymce_textarea" id="text_2"></textarea> 
  				</div>
  			</div>
  				<br>
  				<button class="button is-primary is-rounded is-fullwidth" type="submit">Submit</button>
  		</form>

  </div>    
</section>

<section class="section">
	<div class="container" id="for_grid_svg">
	</div>
</section>

<section class="section">
	<div class="container" id="for_grid_button">
	</div>
</section>

{% load static %}

<!-- <script type="text/javascript" src="{% static 'funding_theory/js/d3_cactus7.js' %}"></script> -->
<script type="text/javascript" src="{% static 'funding_theory/js/d3_cactus.js' %}"></script>

<script type="text/javascript">
	$(document).ready(function(){

		$('#tinymce_form').submit(function(e){

			var content1 = tinyMCE.get('text_1').getContent();
			var content2 = tinyMCE.get('text_2').getContent();
			var data1 = content1.split('<p>').join('').split('</p>').join('').split('&nbsp;').join('');
			var data_json1 = CSVJSON.csv2json(data1,{parseNumbers: true});
			var data2 = content2.split('<p>').join('').split('</p>').join('').split('&nbsp;').join('');
			var data_json2 = CSVJSON.csv2json(data2,{parseNumbers: true});
			var uniq_patients =  _.uniq(_.map(data_json2,d=>d.pat));
			var min_angle = _.min(_.map(data_json2, d=>d.angle));
			var max_angle = _.max(_.map(data_json2, d=>d.angle));
			var min_line_height = _.min(_.concat(_.map(data_json2,d=>d.common), _.map(data_json2,d=>d.only_tumor), _.map(data_json2,d=>d.only_lk)));
			var max_line_height = _.max(_.concat(_.map(data_json2,d=>d.common), _.map(data_json2,d=>d.only_tumor), _.map(data_json2,d=>d.only_lk)));
			var uniq_genes = _.uniq(_.map(data_json1, d=>d.gene));
			var cactus_data = new Array();
			var cactus_meta = new Array();
			var max_value = new Array();
			var max = 0;

			generate_grid_svg(uniq_patients.length, uniq_patients);
			generate_grid_button(uniq_patients.length, uniq_patients);

			for(i=0;i<uniq_patients.length;i++){
				var index1 = _.map(data_json1, (d,e)=>d.pat==uniq_patients[i]?e:'').filter(String);
				var index2 = _.map(data_json2, (d,e)=>d.pat==uniq_patients[i]?e:'').filter(String);
				cactus_data[i] = _.map(index1,d=>data_json1[d]);
				cactus_meta[i] = _.map(index2,d=>data_json2[d]);
				max_value[i] = _.sum(_.map(cactus_data[i],d=>d.VAF),cactus_meta[i][0].common,cactus_meta[i][0].only_lk,cactus_meta[i][0].only_tumor);
			}
			max = _.max(max_value);

			for(aa=0;aa<uniq_patients.length;aa++){
				if(!_.isEmpty(cactus_data[aa])){
					cactus_plot(cactus_data[aa], cactus_meta[aa][0], uniq_genes,  max_angle, min_angle, max_line_height, min_line_height, max);
					download_link(`svg_download_${uniq_patients[aa]}`, uniq_patients[aa]);
				}else{
					$(`#download_${uniq_patients[aa]}`).hide();
				}
			}
			return false;
		});

	});
</script>

<script type="text/javascript">
	function generate_grid_svg(length, patient){

		var loop = _.ceil(length/5);
		for(i=0;i<loop;i++){
			d3.select('#for_grid_svg').appendHTML(`
				<div class="columns" id="row_${i}">
				</div>
				`);

			for(j=0;j<5;j++){
				if((i*5+j)<patient.length){
					d3.select(`#row_${i}`).appendHTML(`
						<div class="column"> <div class="has-text-centered" id="patient_${patient[i*5+j]}">Patient_ID: ${patient[i*5+j]}</div> </div>
						`);
				}else{
					d3.select(`#row_${i}`).appendHTML(`
						<div class="column"> <div class="has-text-centered"}"></div> </div>
						`);					
				}
			}
		}
	}
</script>

<script type="text/javascript">
	function generate_grid_button(length, patient){

		var loop = _.ceil(length/5);
		for(i=0;i<loop;i++){
			d3.select('#for_grid_button').appendHTML(`
				<div class="columns" id="button_row_${i}">
				</div>
				`);

			for(j=0;j<5;j++){
				if((i*5+j)<patient.length){
					d3.select(`#button_row_${i}`).appendHTML(`
						<div class="column"> <a class="button has-text-centered" id="download_${patient[i*5+j]}" href="">Patient_ID: ${patient[i*5+j]}</a> </div>
						`);
				}else{
					d3.select(`#button_row_${i}`).appendHTML(`
						<div class="column"> <div class="has-text-centered"}"></div> </div>
						`);					
				}
			}
		}
	}
</script>

<script type="text/javascript">
	function download_link(svg_name, patient_name){
		var svg = document.getElementById(svg_name);
		var serializer = new XMLSerializer();
		var source = serializer.serializeToString(svg);

		if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/)){
		    source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
		}
		if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/)){
		    source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
		}	

		source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
		var url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);
		document.getElementById(`download_${patient_name}`).href = url;	
	}
</script>
{% endblock %}