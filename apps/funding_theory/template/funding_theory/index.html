{% extends 'funding_theory/base.html' %}

{% block content %}
<script type="text/javascript">
	tinymce.init({
		selector	: '.tinymce_textarea',
		branding	: false,
		theme		: 'silver',
		menubar		: false,
		statusbar	: false, 
		height		: '400',
	});
</script>

<section class="section">
  <div class="container">

  		<form method="post" id="tinymce_form"> {% csrf_token %}
  			<div class="columns">
  				<div class="column"> <textarea class="tinymce_textarea" id="text_1"></textarea> </div>
  				<div class="column"> <textarea class="tinymce_textarea" id="text_2"></textarea> </div>
  			</div>
  				<br>
  				<button class="button is-primary is-rounded is-fullwidth" type="submit">Submit</button>
  		</form>

  </div>    
</section>

<section class="section">
	<div class="container" id="for_grid">
	</div>
</section>

<script type="text/javascript">
	$(document).ready(function(){

		$('#tinymce_form').submit(function(e){

			var content1 = tinyMCE.get('text_1').getContent();
			var content2 = tinyMCE.get('text_2').getContent();
			console.log(content1, content2);
			// var data = content.split('<p>').join('').split('</p>').join('').split('&nbsp;').join('');
			// var data_json = CSVJSON.csv2json(data,{parseNumbers: true});
			// var uniq_patients =  _.uniq(_.map(data_json,d=>d.pat));
			// var uniq_genes = _.uniq(_.map(data_json,d=>d.gene));
			// var grouped_data = new Array();
			// var max_value = new Array();
			// var max = 0;

			// generate_grid(uniq_patients.length, uniq_patients);

			// for(i=0;i<uniq_patients.length;i++){
			// 	var index = _.map(data_json, (d,e)=>d.pat==uniq_patients[i]?e:'').filter(String);
			// 	grouped_data[i] = _.map(index,d=>data_json[d]);
			// 	max_value[i] = _.sum(_.map(grouped_data[i],d=>d.VAF));

			// }
			// max = _.max(max_value);
			// console.log(max_value);

			// $('#data_container').html(JSON.stringify(data_json));
			// for(aa=0;aa<uniq_patients.length;aa++){
			// 	generate_plot(aa+1,grouped_data[aa],max);
			// }
			return false;
		});

	});
</script>

<script type="text/javascript">
	function generate_grid(length, patient){
		var loop = _.ceil(length/5);
		for(i=0;i<loop;i++){
			d3.select('#for_grid').appendHTML(`
				<div class="columns">
					<div class="column"> <div class="has-text-centered" id="patient_${i*5+1}">Patient_ID: ${patient[i*5+0]}</div> </div>
					<div class="column"> <div class="has-text-centered" id="patient_${i*5+2}">Patient_ID: ${patient[i*5+1]}</div> </div>
					<div class="column"> <div class="has-text-centered" id="patient_${i*5+3}">Patient_ID: ${patient[i*5+2]}</div> </div>
					<div class="column"> <div class="has-text-centered" id="patient_${i*5+4}">Patient_ID: ${patient[i*5+3]}</div> </div>
					<div class="column"> <div class="has-text-centered" id="patient_${i*5+5}">Patient_ID: ${patient[i*5+4]}</div> </div>
				</div>
				`);
		}

		for(i=1;i<=(4*loop);i++){
			if(i>length){
				$(`#patient_${i}`).hide();
			}
		}
	}
</script>

<script type="text/javascript">
	function generate_plot(index, cactus_data, max) {
var count = 0;
var patient_name = _.uniq(_.map(cactus_data,d=>d.pat));
var uniq_key = _.uniq(_.map(cactus_data,d=>d.type));
if(uniq_key.length<2){
	uniq_key=='tumor'?uniq_key.push('LK'):uniq_key.push('tumor');
}
var unique = _.map(_.map(cactus_data,(d,i)=>d.level==='uniq'?i:'').filter(String),d=>cactus_data[d]);
var uniq_gene = _.map(unique,d=>d.gene);
var all_genes = _.uniq(_.map(_.orderBy(cactus_data,'level','asc'),d=>d.gene));
var values = new Array();
var only_tumor_vaf = _.map(_.map(cactus_data,(d,i)=>d.type=='tumor'?i:'').filter(String),d=>cactus_data[d].VAF);
var only_lk_vaf = _.map(_.map(cactus_data,(d,i)=>d.type=='LK'?i:'').filter(String),d=>cactus_data[d].VAF);


for(i=0;i<uniq_key.length;i++){
	values[i] = _.map(cactus_data,d=>d.type===uniq_key[i]?({[d.gene]:d.VAF}):'').filter(String);
	values[i] = _.assign(...values[i]);

for(var j=0;j<all_genes.length;j++){
  if(typeof values[i][all_genes[j]] === 'undefined'){
    values[i][all_genes[j]]=0;
  }
}

}

var Margin = {top: 40, right: 20, bottom: 40, left: 60};
var InnerWidth = 432 - Margin.left - Margin.right;
var InnerHeight = 432 - Margin.top - Margin.bottom;
var stack = d3.stack().keys(all_genes);

var x = d3.scaleLinear()
          .domain([0, 1])
          .range([0,InnerWidth]);

var x_axis = d3.scaleLinear()
               .domain([0, max])
               .range([0,InnerWidth]);

var y = d3.scaleLinear()
          .domain([0, 4.3])
          .rangeRound([0,InnerHeight]);

var y_axis = d3.scaleBand()
          	   .domain(_.concat(['hello'],uniq_key,['yello']))
          	   .rangeRound([0,InnerHeight]);
          	   // .padding(0.1);

var y_axis1 = d3.scaleBand()
               .domain(_.concat(uniq_key))
               .rangeRound([0,InnerHeight]);

var svg9 = d3.select(`#patient_${index}`).append("svg")
             .attr("preserveAspectRatio", "xMinYMin meet")
             .attr("viewBox", `0 0 ${InnerWidth + Margin.left + Margin.right} ${InnerHeight + Margin.top + Margin.bottom}`)
             // .style("background","lightblue")
             .append("g")
             .attr("transform", "translate(" + Margin.left + "," + Margin.top + ")");

var zz1 = stack(values);

var series = svg9.selectAll("g").data(stack(values))
                        .enter().append("g")
                        .attr('transform',`translate(0, ${InnerWidth}) rotate(-90)`)
                        .style("fill", (d,i)=>d3.schemeSet3[i]);

        series.selectAll("rect").data(function(d){return d;})
                .enter().append("rect")
                .attr("height",y(1))
                .attr("x", function(d){return x_axis(d[0]);})
                .attr("y", function(d,i){return y_axis(uniq_key[i]);})
                .attr("id", function(d, i) { return (x(d[1]) - x(d[0]))<1?'':`${patient_name}_${counting()}`; })
                .attr("width", function(d){return x_axis(d[1]) - x_axis(d[0]);});

svg9.append("g").attr('transform', `translate(0, ${InnerHeight})`)
                .style("font", "18px sans").call(d3.axisBottom(y_axis)
                                                   .tickFormat(function(d,i){if(i==1||i==2){ return d; }})
                                                   // .style("display",function(d,i){ if(i!=1 && i!=2){ return "none";} else { return "block";}})
                                                   );
svg9.selectAll(".tick:first-of-type line").attr("stroke", "rgba(0,0,0,0)");
svg9.selectAll(".tick:last-of-type line").attr("stroke", "rgba(0,0,0,0)");
// svg9.append("g").attr('transform', `translate(0, ${InnerHeight})`).style("font", "13px times").call(d3.axisBottom(x_axisper).tickFormat(function(d,i){return i%2==0?d:'';}));


function counting(){
  count=count+1;
  return count;
}
return;
	}

</script>
{% endblock %}